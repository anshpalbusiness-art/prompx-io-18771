import{n as xe,r as o,j as e,h as u,i as j,k as p,m as f,l as v,B as z,o as l}from"./index-C2MjUc6j.js";import{s as d}from"./index-z1pI4DUj.js";import{L as he,F as ue}from"./Layout-lstxxF2Q.js";import{T as je,a as pe,b as _,c as A}from"./tabs-CyOF3ppl.js";import{T as S,a as T,b as x,c,d as U,e as n,A as fe,f as ge,g as be,h as Ne,i as we,j as ye,k as ve,l as _e}from"./alert-dialog-BE3E0pZr.js";import{B as G}from"./badge-BmD5Ofur.js";import{I as Ae}from"./index-C0NKCsYR.js";import{U as Se,a as Te}from"./index-BOT--vBY.js";import{D as Ue}from"./dollar-sign-DZ70S1lw.js";import{R as Ee}from"./refresh-cw-D-B7VL-M.js";import{P as ke}from"./plus-XtvXWcDu.js";import{M as J}from"./mail-Bt2QdJiG.js";import{T as Ce}from"./trash-2-DBuHC0nM.js";const Ke=()=>{const E=xe(),[w,Q]=o.useState(null),[X,Y]=o.useState(!1),[Z,ee]=o.useState(!0),[i,se]=o.useState(null),[k,re]=o.useState([]),[g,I]=o.useState(""),[ae,q]=o.useState(!1),[C,D]=o.useState(null),[$,H]=o.useState(!1);o.useEffect(()=>{(async()=>{const{data:{session:a}}=await d.auth.getSession();if(!a){E("/auth");return}Q(a.user);const{data:h,error:R}=await d.from("user_roles").select("role").eq("user_id",a.user.id).eq("role","admin").maybeSingle();if(R||!h){l.error("Access denied. Admin privileges required."),E("/dashboard");return}Y(!0),M(),P(),ee(!1)})()},[E]);const M=async()=>{try{const{count:s}=await d.from("profiles").select("*",{count:"exact",head:!0}),{data:a,count:h}=await d.from("user_subscriptions").select("*, subscription_plans(plan_name, price_monthly)",{count:"exact"}).eq("status","active"),R=(a==null?void 0:a.reduce((r,t)=>{var V,W;const m=((V=t.subscription_plans)==null?void 0:V.plan_name)||"Unknown",y=((W=t.subscription_plans)==null?void 0:W.price_monthly)||0,L=r.find(me=>me.plan_name===m);return L?(L.count++,L.revenue+=y):r.push({plan_name:m,count:1,revenue:y}),r},[]))||[],{data:b}=await d.from("usage_tracking").select("user_id, count").eq("resource_type","prompt_optimization"),ne=(b==null?void 0:b.reduce((r,t)=>r+t.count,0))||0,K=(b==null?void 0:b.reduce((r,t)=>{const m=r.find(y=>y.user_id===t.user_id);return m?m.count+=t.count:r.push({user_id:t.user_id,count:t.count}),r},[]))||[],le=K.map(r=>r.user_id),{data:B}=await d.from("profiles").select("id, email").in("id",le),de=K.map(r=>{var t;return{...r,email:((t=B==null?void 0:B.find(m=>m.id===r.user_id))==null?void 0:t.email)||"Unknown"}}).sort((r,t)=>t.count-r.count),{data:N}=await d.from("prompt_history").select("id, user_id, original_prompt, created_at, platform").order("created_at",{ascending:!1}).limit(20),ce=(N==null?void 0:N.map(r=>r.user_id))||[],{data:F}=await d.from("profiles").select("id, email").in("id",ce),oe=(N==null?void 0:N.map(r=>{var t;return{id:r.id,user_email:((t=F==null?void 0:F.find(m=>m.id===r.user_id))==null?void 0:t.email)||"Unknown",prompt:r.original_prompt,created_at:r.created_at,platform:r.platform||"N/A"}}))||[];se({totalUsers:s||0,totalSubscriptions:h||0,planBreakdown:R,promptUsage:{total:ne,byUser:de},recentPrompts:oe})}catch(s){console.error("Error loading dashboard stats:",s),l.error("Failed to load dashboard statistics")}},P=async()=>{try{const{data:s,error:a}=await d.from("admin_emails").select("*").order("created_at",{ascending:!1});if(a)throw a;re(s||[])}catch(s){console.error("Error loading admin emails:",s),l.error("Failed to load admin emails")}},O=async()=>{if(!g.trim()){l.error("Please enter an email address");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(g)){l.error("Please enter a valid email address");return}q(!0);try{const{error:a}=await d.from("admin_emails").insert({email:g.toLowerCase().trim(),added_by:w==null?void 0:w.id});if(a){if(a.code==="23505")l.error("This email is already in the admin list");else throw a;return}l.success(`${g} added to admin list`),I(""),P()}catch(a){console.error("Error adding admin email:",a),l.error("Failed to add admin email")}finally{q(!1)}},ie=async(s,a)=>{try{const{error:h}=await d.from("admin_emails").delete().eq("id",s);if(h)throw h;l.success(`${a} removed from admin list`),P(),D(null)}catch(h){console.error("Error deleting admin email:",h),l.error("Failed to remove admin email")}},te=async()=>{H(!0);try{const{error:s}=await d.rpc("sync_existing_admins");if(s)throw s;l.success("Successfully synced existing users with admin emails"),M()}catch(s){console.error("Error syncing admins:",s),l.error("Failed to sync existing admins")}finally{H(!1)}};return Z?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsx("div",{className:"animate-pulse-subtle",children:e.jsx("div",{className:"w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin"})})}):X?e.jsxs(he,{user:w,showHeader:!1,children:[e.jsx("div",{className:"w-full min-h-screen bg-gradient-to-b from-background via-background to-muted/20",children:e.jsxs("div",{className:"container mx-auto max-w-7xl py-8 px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold mb-2 text-gradient",children:"Admin Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Comprehensive platform analytics and user insights"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsxs(u,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Total Users"}),e.jsx(Se,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold",children:(i==null?void 0:i.totalUsers)||0}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Registered accounts"})]})]}),e.jsxs(u,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Active Subscriptions"}),e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold",children:(i==null?void 0:i.totalSubscriptions)||0}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Paid plans"})]})]}),e.jsxs(u,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Total Revenue"}),e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(f,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:["$",(i==null?void 0:i.planBreakdown.reduce((s,a)=>s+a.revenue,0))||0,"/mo"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Monthly recurring"})]})]}),e.jsxs(u,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Total Prompts"}),e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold",children:(i==null?void 0:i.promptUsage.total)||0}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Optimizations run"})]})]})]}),e.jsxs(je,{defaultValue:"subscriptions",className:"w-full",children:[e.jsxs(pe,{className:"grid w-full grid-cols-4",children:[e.jsx(_,{value:"subscriptions",children:"Subscriptions"}),e.jsx(_,{value:"usage",children:"Usage Stats"}),e.jsx(_,{value:"prompts",children:"Recent Prompts"}),e.jsx(_,{value:"admins",children:"Admin Emails"})]}),e.jsx(A,{value:"subscriptions",className:"mt-6",children:e.jsxs(u,{children:[e.jsxs(j,{children:[e.jsx(p,{children:"Plan Breakdown"}),e.jsx(v,{children:"Active subscriptions by plan type"})]}),e.jsx(f,{children:e.jsxs(S,{children:[e.jsx(T,{children:e.jsxs(x,{children:[e.jsx(c,{children:"Plan Name"}),e.jsx(c,{className:"text-right",children:"Subscribers"}),e.jsx(c,{className:"text-right",children:"Monthly Revenue"})]})}),e.jsx(U,{children:i==null?void 0:i.planBreakdown.map(s=>e.jsxs(x,{children:[e.jsx(n,{className:"font-medium",children:e.jsx(G,{variant:"outline",children:s.plan_name})}),e.jsx(n,{className:"text-right",children:s.count}),e.jsxs(n,{className:"text-right",children:["$",s.revenue]})]},s.plan_name))})]})})]})}),e.jsx(A,{value:"usage",className:"mt-6",children:e.jsxs(u,{children:[e.jsxs(j,{children:[e.jsx(p,{children:"Prompt Usage by User"}),e.jsx(v,{children:"Top users by optimization count"})]}),e.jsx(f,{children:e.jsxs(S,{children:[e.jsx(T,{children:e.jsxs(x,{children:[e.jsx(c,{children:"User Email"}),e.jsx(c,{className:"text-right",children:"Prompts Optimized"})]})}),e.jsx(U,{children:i==null?void 0:i.promptUsage.byUser.slice(0,20).map(s=>e.jsxs(x,{children:[e.jsx(n,{className:"font-medium",children:s.email}),e.jsx(n,{className:"text-right",children:s.count})]},s.user_id))})]})})]})}),e.jsx(A,{value:"prompts",className:"mt-6",children:e.jsxs(u,{children:[e.jsxs(j,{children:[e.jsx(p,{children:"Recent Prompts"}),e.jsx(v,{children:"Latest prompt optimizations across the platform"})]}),e.jsx(f,{children:e.jsxs(S,{children:[e.jsx(T,{children:e.jsxs(x,{children:[e.jsx(c,{children:"User"}),e.jsx(c,{children:"Prompt"}),e.jsx(c,{children:"Platform"}),e.jsx(c,{children:"Date"})]})}),e.jsx(U,{children:i==null?void 0:i.recentPrompts.map(s=>e.jsxs(x,{children:[e.jsx(n,{className:"font-medium",children:s.user_email}),e.jsx(n,{className:"max-w-md truncate",children:s.prompt}),e.jsx(n,{children:e.jsx(G,{variant:"secondary",children:s.platform})}),e.jsx(n,{children:new Date(s.created_at).toLocaleDateString()})]},s.id))})]})})]})}),e.jsx(A,{value:"admins",className:"mt-6",children:e.jsxs(u,{children:[e.jsx(j,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(p,{children:"Admin Email Management"}),e.jsx(v,{children:"Users with these emails will automatically become admins"})]}),e.jsxs(z,{onClick:te,disabled:$,variant:"outline",size:"sm",children:[e.jsx(Ee,{className:`h-4 w-4 mr-2 ${$?"animate-spin":""}`}),"Sync Existing Users"]})]})}),e.jsxs(f,{children:[e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx(Ae,{type:"email",placeholder:"Enter email address...",value:g,onChange:s=>I(s.target.value),onKeyPress:s=>s.key==="Enter"&&O(),className:"flex-1"}),e.jsxs(z,{onClick:O,disabled:ae||!g.trim(),children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Add Admin"]})]}),e.jsxs(S,{children:[e.jsx(T,{children:e.jsxs(x,{children:[e.jsx(c,{children:"Email Address"}),e.jsx(c,{children:"Added On"}),e.jsx(c,{className:"text-right",children:"Actions"})]})}),e.jsx(U,{children:k.length===0?e.jsx(x,{children:e.jsxs(n,{colSpan:3,className:"text-center text-muted-foreground py-8",children:[e.jsx(J,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No admin emails configured yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Add your first admin email above"})]})}):k.map(s=>e.jsxs(x,{children:[e.jsx(n,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4 text-muted-foreground"}),s.email]})}),e.jsx(n,{children:new Date(s.created_at).toLocaleDateString()}),e.jsx(n,{className:"text-right",children:e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>D(s.id),children:e.jsx(Ce,{className:"h-4 w-4 text-destructive"})})})]},s.id))})]})]})]})})]})]})}),e.jsx(fe,{open:!!C,onOpenChange:s=>!s&&D(null),children:e.jsxs(ge,{children:[e.jsxs(be,{children:[e.jsx(Ne,{children:"Remove Admin Email?"}),e.jsx(we,{children:"This will remove the email from the admin list. Users who already have admin access will keep it until you manually revoke it."})]}),e.jsxs(ye,{children:[e.jsx(ve,{children:"Cancel"}),e.jsx(_e,{onClick:()=>{const s=k.find(a=>a.id===C);s&&ie(C,s.email)},className:"bg-destructive hover:bg-destructive/90",children:"Remove"})]})]})})]}):null};export{Ke as default};
